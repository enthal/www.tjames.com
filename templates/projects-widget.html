<div id="projects-widget" class="projects-widget">
  <div class="label-buttons-container">
    <span class="label-buttons-label"></span>
    <div class="label-buttons"></div>
  </div>
  <div>
    <%= $.recurse(projects) %>
  </div>
</div>

<script>
    const projects = Array.from(document.querySelectorAll('#projects-widget .project'));

    // Collect unique labels across projects, indexing projects by label, and labels by project
    const labelSet = new Set();
    const labelSetByProject = new Map();
    projects.forEach( project => {
      const projectLabelSet = new Set(project.attributes.labels.value.split(/\s+/));
      labelSetByProject.set(project, projectLabelSet);
      projectLabelSet.forEach( label => {
        labelSet.add(label);
      } )
    });
    console.log({ labelSet, labelSetByProject });

    // Create label-selector buttons
    const activeLabelSet = new Set();
    labelSet.forEach(label => {
      const button = document.createElement('button');
      button.innerText = label;

      button.addEventListener('click', () => {

        // Toggle button state
        button.classList.toggle('active');
        activeLabelSet[activeLabelSet.has(label) ? 'delete' : 'add'](label);  // toggle

        // Activate only each project bearing ALL active labels (if any)
        const activeProjectSet = new Set( projects.filter( project =>
          !activeLabelSet.size || isSuperset(labelSetByProject.get(project), activeLabelSet)
        ) );
        console.log({ activeLabelSet, activeProjectSet });
        projects.forEach( project =>
          project.classList[ activeProjectSet.has(project) ? 'add' : 'remove' ]('active')
        );

        // Show project match count
        document.querySelector('#projects-widget .label-buttons-label')
          .textContent = activeLabelSet.size ? activeProjectSet.size : '';

        // Mark .any-active for overall style
        document.querySelector('#projects-widget .label-buttons-container')
          .classList[activeLabelSet.size ? 'add' : 'remove']('any-active');

        // TODO: track in google analytics
      });

      document.querySelector('#projects-widget .label-buttons').appendChild( button );
    });

    // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Set#Implementing_basic_set_operations
    function isSuperset(set, subset) {
      for (var elem of subset) {
          if (!set.has(elem)) {
              return false;
          }
      }
      return true;
    }
</script>
